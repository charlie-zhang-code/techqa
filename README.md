# Django技术问答平台后端设计（对接微信小程序）

一个类似Stack Overflow的技术问答平台后端，使用Django Rest Framework (DRF)实现，并支持微信小程序对接。

## 系统设计与架构

### 技术栈
- Django 4.x
- Django Rest Framework
- Django Filter (用于过滤)
- SimpleJWT (用于认证)
- SQLite(数据库)

### 功能模块
1. 用户系统（集成微信登录）
2. 问题管理
3. 回答管理
4. 评论系统
5. 投票系统（赞同/反对）
6. 标签系统
7. 搜索功能
8. 通知系统

## 项目初始化

### 创建项目
```bash
# 安装依赖
pip install django djangorestframework django-filter djangorestframework-simplejwt pillow python-dotenv

# 创建项目
django-admin startproject techqa
cd techqa
django-admin startapp qa
```

### 项目结构
```
techqa/
├── qa/                    # 主应用
│   ├── migrations/        
│   ├── models/            # 模型分模块存放
│   ├── serializers/       # 序列化器
│   ├── services/          # 业务逻辑
│   ├── signals/           # 信号
│   ├── tasks/             # 异步任务
│   ├── tests/             # 测试
│   ├── utils/             # 工具类
│   ├── views/             # 视图
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   └── models.py          # 基础模型
├── techqa/
│   ├── __init__.py
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── manage.py
└── requirements.txt
```

## 基础配置

### settings.py 配置
```python
"""
Django settings for techqa project.

Generated by 'django-admin startproject' using Django 5.2.1.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""
import os
from datetime import timedelta
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-d+u*9re_$i1&0z0v9-1z!_9(pynu%8h2bw+_-^+m0h77hk!nyw'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # 第三方应用
    'rest_framework',
    'rest_framework_simplejwt',
    'django_filters',
     'drf_spectacular',

    # 本地应用
    'qa',

]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'techqa.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'techqa.wsgi.application'

# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# DRF配置
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticatedOrReadOnly',
    ),
    'DEFAULT_RENDERER_CLASSES': (
        'rest_framework.renderers.JSONRenderer',  # 只保留 JSONRenderer
    ),
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

# JWT配置
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(days=1),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': True,
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'AUTH_HEADER_TYPES': ('Bearer',),
}

# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

# 国际化
LANGUAGE_CODE = 'zh-hans'
TIME_ZONE = 'Asia/Shanghai'
USE_I18N = True
USE_L10N = True
USE_TZ = True

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
AUTH_USER_MODEL = 'qa.User'
# 微信小程序配置
WX_APP_ID = os.getenv('WX_APP_ID', 'wx9a8833504749a11a')
WX_APP_SECRET = os.getenv('WX_APP_SECRET', '16c6c2f33bd76dd08cb77f0f04b308fd')
WX_LOGIN_URL = 'https://api.weixin.qq.com/sns/jscode2session'

SPECTACULAR_SETTINGS = {
    'TITLE': 'Your Project API',
    'DESCRIPTION': 'Your project description',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
}
```

## 模型设计

首先创建基础模型：

```python
# qa/models/__init__.py
from .base import *
from .user import *
from .question import *
from .answer import *
from .comment import *
from .vote import *
from .tag import *
from .notification import *
from .banner import *
```

### 基础模型
```python
# qa/models/base.py
from django.db import models

class BaseModel(models.Model):
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="更新时间")
    is_active = models.BooleanField(default=True, verbose_name="是否有效")

    class Meta:
        abstract = True
```

### 轮播图模型

```python
# qa/models/banner.py
from django.db import models
from .base import BaseModel

class Banner(BaseModel):
    title = models.CharField(max_length=100, verbose_name="标题")
    image = models.ImageField(upload_to='banners/', verbose_name="图片")
    url = models.URLField(blank=True, null=True, verbose_name="跳转链接")
    description = models.TextField(blank=True, null=True, verbose_name="描述")
    is_active = models.BooleanField(default=True, verbose_name="是否激活")
    order = models.PositiveIntegerField(default=0, verbose_name="排序")

    class Meta:
        verbose_name = "轮播图"
        verbose_name_plural = verbose_name
        ordering = ['order', '-created_at']

    def __str__(self):
        return self.title
```

### 用户模型

```python
# qa/models/user.py
from django.db import models
from django.contrib.auth.models import AbstractUser
from .base import BaseModel


class User(AbstractUser, BaseModel):
    wx_openid = models.CharField(max_length=64, unique=True, null=True, blank=True, verbose_name="微信OpenID")
    wx_unionid = models.CharField(max_length=64, unique=True, null=True, blank=True, verbose_name="微信UnionID")
    avatar = models.URLField(max_length=255, blank=True, null=True, verbose_name="头像")
    bio = models.TextField(blank=True, null=True, verbose_name="个人简介")
    location = models.CharField(max_length=100, blank=True, null=True, verbose_name="所在地")
    website = models.URLField(blank=True, null=True, verbose_name="个人网站")
    reputation = models.IntegerField(default=0, verbose_name="声望")

    # 关注相关
    following_users = models.ManyToManyField(
        'self', symmetrical=False, related_name='followers', blank=True, verbose_name="关注的用户"
    )
    following_tags = models.ManyToManyField(
        'Tag', related_name='followers', blank=True, verbose_name="关注的标签"
    )

    # 添加自定义的 related_name
    groups = models.ManyToManyField(
        'auth.Group',
        verbose_name='groups',
        blank=True,
        help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.',
        related_name="qa_user_set",
        related_query_name="qa_user",
    )
    user_permissions = models.ManyToManyField(
        'auth.Permission',
        verbose_name='user permissions',
        blank=True,
        help_text='Specific permissions for this user.',
        related_name="qa_user_set",
        related_query_name="qa_user",
    )

    class Meta:
        verbose_name = "用户"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.username
```

### 标签模型
```python
# qa/models/tag.py
from django.db import models
from .base import BaseModel

class Tag(BaseModel):
    name = models.CharField(max_length=50, unique=True, verbose_name="标签名")
    slug = models.SlugField(max_length=50, unique=True, verbose_name="Slug")
    description = models.TextField(blank=True, null=True, verbose_name="描述")
    usage_count = models.PositiveIntegerField(default=0, verbose_name="使用次数")

    class Meta:
        verbose_name = "标签"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.name
```

### 问题模型
```python
# qa/models/question.py
from django.db import models
from .base import BaseModel
from .user import User
from .tag import Tag

class Question(BaseModel):
    title = models.CharField(max_length=255, verbose_name="标题")
    content = models.TextField(verbose_name="内容")
    author = models.ForeignKey(
        User, on_delete=models.CASCADE, related_name='questions', verbose_name="作者"
    )
    tags = models.ManyToManyField(Tag, related_name='questions', verbose_name="标签")
    views = models.PositiveIntegerField(default=0, verbose_name="浏览数")
    votes = models.IntegerField(default=0, verbose_name="投票数")
    has_accepted_answer = models.BooleanField(default=False, verbose_name="有采纳的回答")
    is_anonymous = models.BooleanField(default=False, verbose_name="匿名提问")

    class Meta:
        verbose_name = "问题"
        verbose_name_plural = verbose_name
        ordering = ['-created_at']

    def __str__(self):
        return self.title

    def update_votes(self):
        self.votes = self.question_votes.filter(vote_type='up').count() - \
                     self.question_votes.filter(vote_type='down').count()
        self.save()
```

### 回答模型
```python
# qa/models/answer.py
from django.db import models
from .base import BaseModel
from .user import User
from .question import Question

class Answer(BaseModel):
    content = models.TextField(verbose_name="内容")
    author = models.ForeignKey(
        User, on_delete=models.CASCADE, related_name='answers', verbose_name="作者"
    )
    question = models.ForeignKey(
        Question, on_delete=models.CASCADE, related_name='answers', verbose_name="问题"
    )
    votes = models.IntegerField(default=0, verbose_name="投票数")
    is_accepted = models.BooleanField(default=False, verbose_name="是否被采纳")
    is_anonymous = models.BooleanField(default=False, verbose_name="匿名回答")

    class Meta:
        verbose_name = "回答"
        verbose_name_plural = verbose_name
        ordering = ['-is_accepted', '-votes', '-created_at']

    def __str__(self):
        return f"{self.author.username}的回答"

    def update_votes(self):
        self.votes = self.answer_votes.filter(vote_type='up').count() - \
                     self.answer_votes.filter(vote_type='down').count()
        self.save()

    def accept(self):
        # 确保一个问题只有一个被采纳的回答
        Answer.objects.filter(question=self.question).update(is_accepted=False)
        self.is_accepted = True
        self.save()
        self.question.has_accepted_answer = True
        self.question.save()
```

### 评论模型
```python
# qa/models/comment.py
from django.db import models
from rest_framework.exceptions import ValidationError

from .base import BaseModel
from .user import User
from .question import Question
from .answer import Answer


class Comment(BaseModel):
    content = models.TextField(verbose_name="内容")
    author = models.ForeignKey(
        User, on_delete=models.CASCADE, related_name='comments', verbose_name="作者"
    )

    # 评论可以针对问题或回答
    question = models.ForeignKey(
        Question, on_delete=models.CASCADE, related_name='comments', null=True, blank=True, verbose_name="问题"
    )
    answer = models.ForeignKey(
        Answer, on_delete=models.CASCADE, related_name='comments', null=True, blank=True, verbose_name="回答"
    )

    reply_to = models.ForeignKey(
        'self', on_delete=models.CASCADE, null=True, blank=True, related_name='replies', verbose_name="回复"
    )

    class Meta:
        verbose_name = "评论"
        verbose_name_plural = verbose_name
        ordering = ['created_at']

    def __str__(self):
        return f"{self.author.username}的评论"

    def clean(self):
        if not self.question and not self.answer:
            raise ValidationError("评论必须关联问题或回答")
        if self.question and self.answer:
            raise ValidationError("评论不能同时关联问题和回答")
```

### 投票模型
```python
# qa/models/vote.py
from django.db import models
from rest_framework.exceptions import ValidationError

from .base import BaseModel
from .user import User
from .question import Question
from .answer import Answer


class Vote(BaseModel):
    VOTE_TYPES = (
        ('up', '赞同'),
        ('down', '反对'),
    )

    vote_type = models.CharField(max_length=10, choices=VOTE_TYPES, verbose_name="投票类型")
    user = models.ForeignKey(
        User, on_delete=models.CASCADE, related_name='votes', verbose_name="用户"
    )

    # 投票可以针对问题或回答
    question = models.ForeignKey(
        Question, on_delete=models.CASCADE, related_name='question_votes', null=True, blank=True, verbose_name="问题"
    )
    answer = models.ForeignKey(
        Answer, on_delete=models.CASCADE, related_name='answer_votes', null=True, blank=True, verbose_name="回答"
    )

    class Meta:
        verbose_name = "投票"
        verbose_name_plural = verbose_name
        unique_together = [
            ['user', 'question'],
            ['user', 'answer'],
        ]

    def __str__(self):
        return f"{self.user.username}的投票"

    def clean(self):
        if not self.question and not self.answer:
            raise ValidationError("投票必须关联问题或回答")
        if self.question and self.answer:
            raise ValidationError("投票不能同时关联问题和回答")

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        if self.question:
            self.question.update_votes()
        elif self.answer:
            self.answer.update_votes()
```

### 通知模型
```python
# qa/models/notification.py
from django.db import models
from .base import BaseModel
from .user import User
from .question import Question
from .answer import Answer
from .comment import Comment


class Notification(BaseModel):
    NOTIFICATION_TYPES = (
        ('question_answered', '问题被回答'),
        ('answer_commented', '回答被评论'),
        ('answer_accepted', '回答被采纳'),
        ('mentioned', '被提及'),
    )

    notification_type = models.CharField(max_length=20, choices=NOTIFICATION_TYPES, verbose_name="通知类型")
    recipient = models.ForeignKey(
        User, on_delete=models.CASCADE, related_name='notifications', verbose_name="接收者"
    )
    is_read = models.BooleanField(default=False, verbose_name="是否已读")

    # 通知关联的内容
    question = models.ForeignKey(
        Question, on_delete=models.CASCADE, null=True, blank=True, verbose_name="问题"
    )
    answer = models.ForeignKey(
        Answer, on_delete=models.CASCADE, null=True, blank=True, verbose_name="回答"
    )
    comment = models.ForeignKey(
        Comment, on_delete=models.CASCADE, null=True, blank=True, verbose_name="评论"
    )

    # 触发通知的用户
    actor = models.ForeignKey(
        User, on_delete=models.CASCADE, null=True, blank=True, related_name='acted_notifications', verbose_name="触发者"
    )

    class Meta:
        verbose_name = "通知"
        verbose_name_plural = verbose_name
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.get_notification_type_display()}通知"
```

## Django Admin 定制化

```py
# qa/admin.py
from django.contrib import admin
from qa.models import User, Question, Answer, Comment, Vote, Tag, Notification, Banner

class UserAdmin(admin.ModelAdmin):
    list_display = ('username', 'email', 'date_joined', 'is_active')
    search_fields = ('username', 'email')
    list_filter = ('is_active', 'date_joined')

class QuestionAdmin(admin.ModelAdmin):
    list_display = ('title', 'author', 'created_at', 'views', 'votes', 'has_accepted_answer')
    search_fields = ('title', 'content')
    list_filter = ('created_at', 'tags')

class AnswerAdmin(admin.ModelAdmin):
    list_display = ('content', 'author', 'question', 'created_at', 'votes', 'is_accepted')
    search_fields = ('content',)
    list_filter = ('created_at', 'is_accepted')

class CommentAdmin(admin.ModelAdmin):
    list_display = ('content', 'author', 'question', 'answer', 'created_at')
    search_fields = ('content',)
    list_filter = ('created_at',)

class VoteAdmin(admin.ModelAdmin):
    list_display = ('user', 'question', 'answer', 'vote_type', 'created_at')
    list_filter = ('vote_type', 'created_at')

class TagAdmin(admin.ModelAdmin):
    list_display = ('name', 'usage_count')
    search_fields = ('name',)
    list_filter = ('usage_count',)

class NotificationAdmin(admin.ModelAdmin):
    list_display = ('notification_type', 'recipient', 'actor', 'created_at')
    list_filter = ('notification_type', 'created_at')

class BannerAdmin(admin.ModelAdmin):
    list_display = ('title', 'image', 'url', 'is_active', 'order')
    list_filter = ('is_active', 'order')

# 注册自定义的Admin类
admin.site.register(User, UserAdmin)
admin.site.register(Question, QuestionAdmin)
admin.site.register(Answer, AnswerAdmin)
admin.site.register(Comment, CommentAdmin)
admin.site.register(Vote, VoteAdmin)
admin.site.register(Tag, TagAdmin)
admin.site.register(Notification, NotificationAdmin)
admin.site.register(Banner, BannerAdmin)
```

## 序列化器

创建序列化器目录和文件：

```python
# qa/serializers/__init__.py
from .user import *
from .tag import *
from .question import *
from .answer import *
from .comment import *
from .vote import *
from .notification import *
from .banner import *
```

### 轮播图序列化器

```python
# qa/serializers/banner.py
from rest_framework import serializers
from qa.models import Banner

class BannerSerializer(serializers.ModelSerializer):
    image_url = serializers.SerializerMethodField()

    class Meta:
        model = Banner
        fields = ['id', 'title', 'image_url', 'url', 'description', 'order', 'created_at']
        read_only_fields = fields

    def get_image_url(self, obj):
        request = self.context.get('request')
        if obj.image and hasattr(obj.image, 'url'):
            return request.build_absolute_uri(obj.image.url)
        return None
```

### 用户序列化器

```python
# qa/serializers/user.py
from rest_framework import serializers
from django.contrib.auth import get_user_model
from qa.models import Tag

from rest_framework import serializers
from django.contrib.auth import get_user_model
from qa.models import Tag

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    is_following = serializers.SerializerMethodField()
    following_users_count = serializers.SerializerMethodField()
    followers_count = serializers.SerializerMethodField()
    questions_count = serializers.SerializerMethodField()
    answers_count = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = [
            'id', 'username', 'avatar', 'bio', 'location', 'website',
            'reputation', 'date_joined', 'is_following', 'following_users_count',
            'followers_count', 'questions_count', 'answers_count'
        ]
        read_only_fields = fields

    def get_is_following(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            return request.user.following_users.filter(id=obj.id).exists()
        return False

    def get_following_users_count(self, obj):
        return obj.following_users.count()

    def get_followers_count(self, obj):
        return obj.followers.count()

    def get_questions_count(self, obj):
        return obj.questions.count()

    def get_answers_count(self, obj):
        return obj.answers.count()


class UserCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['username', 'avatar', 'bio', 'location', 'website']
        extra_kwargs = {
            'username': {'required': True},
        }


class UserUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['username', 'avatar', 'bio', 'location', 'website']


class UserFollowSerializer(serializers.Serializer):
    action = serializers.ChoiceField(choices=['follow', 'unfollow'])


class WxLoginSerializer(serializers.Serializer):
    code = serializers.CharField(required=True)
    encrypted_data = serializers.CharField(required=False)
    iv = serializers.CharField(required=False)
```

### 标签序列化器
```python
# qa/serializers/tag.py
from rest_framework import serializers
from qa.models import Tag


class TagSerializer(serializers.ModelSerializer):
    is_following = serializers.SerializerMethodField()

    class Meta:
        model = Tag
        fields = ['id', 'name', 'slug', 'description', 'usage_count', 'is_following']
        read_only_fields = fields

    def get_is_following(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            return request.user.following_tags.filter(id=obj.id).exists()
        return False


class TagFollowSerializer(serializers.Serializer):
    action = serializers.ChoiceField(choices=['follow', 'unfollow'])
```

### 问题序列化器
```python
# qa/serializers/question.py
from django.template.defaultfilters import slugify
from rest_framework import serializers
from qa.models import Question, Tag, Answer, Vote
from qa.serializers.tag import TagSerializer
from qa.serializers.answer import AnswerSerializer
from qa.serializers.user import UserSerializer


class QuestionSerializer(serializers.ModelSerializer):
    answers = AnswerSerializer(many=True, read_only=True)
    author = UserSerializer(read_only=True)
    tags = TagSerializer(many=True, read_only=True)
    answers_count = serializers.SerializerMethodField()
    comments_count = serializers.SerializerMethodField()
    user_vote = serializers.SerializerMethodField()
    is_following = serializers.SerializerMethodField()
    created_at = serializers.SerializerMethodField()

    class Meta:
        model = Question
        fields = [
            'id', 'title', 'content', 'author', 'tags', 'views', 'votes',
            'created_at', 'updated_at', 'has_accepted_answer', 'is_anonymous',
            'answers', 'answers_count', 'comments_count', 'user_vote', 'is_following'
        ]
        read_only_fields = fields

    def get_answers_count(self, obj):
        return obj.answers.count()

    def get_comments_count(self, obj):
        return obj.comments.count()

    def get_user_vote(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            vote = obj.question_votes.filter(user=request.user).first()
            if vote:
                return vote.vote_type
        return None

    def get_is_following(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            return request.user.following_users.filter(id=obj.author.id).exists()
        return False

    def get_created_at(self, obj):
        return obj.created_at.strftime("%Y年%m月%d日")


class QuestionCreateSerializer(serializers.ModelSerializer):
    tag_names = serializers.ListField(
        child=serializers.CharField(max_length=50),
        write_only=True,
        required=False
    )

    class Meta:
        model = Question
        fields = ['title', 'content', 'is_anonymous', 'tag_names']
        read_only_fields = fields

    def create(self, validated_data):
        tag_names = validated_data.pop('tag_names', [])
        question = Question.objects.create(**validated_data)
        tags = []
        for name in tag_names:
            tag, created = Tag.objects.get_or_create(name=name)
            if not created:
                tag.slug = slugify(tag.name)
                counter = 1
                while Tag.objects.filter(slug=tag.slug).exclude(id=tag.id).exists():
                    tag.slug = f"{slugify(tag.name)}-{counter}"
                    counter += 1
                tag.save()
            tags.append(tag)
        question.tags.set(tags)
        return question


class QuestionUpdateSerializer(serializers.ModelSerializer):
    tag_names = serializers.ListField(
        child=serializers.CharField(max_length=50),
        write_only=True,
        required=False
    )

    class Meta:
        model = Question
        fields = ['title', 'content', 'is_anonymous', 'tag_names']

    def update(self, instance, validated_data):
        tag_names = validated_data.pop('tag_names', None)
        instance = super().update(instance, validated_data)

        if tag_names is not None:
            tags = []
            for name in tag_names:
                tag, created = Tag.objects.get_or_create(name=name)
                tags.append(tag)
            instance.tags.set(tags)

        return instance


class QuestionVoteSerializer(serializers.Serializer):
    vote_type = serializers.ChoiceField(choices=Vote.VOTE_TYPES)
```

### 回答序列化器
```python
# qa/serializers/answer.py
from rest_framework import serializers
from qa.models import Answer, Vote
from qa.serializers.user import UserSerializer
from qa.serializers.comment import CommentSerializer


class AnswerSerializer(serializers.ModelSerializer):
    author = UserSerializer(read_only=True)
    comments = CommentSerializer(many=True, read_only=True)
    comments_count = serializers.SerializerMethodField()
    user_vote = serializers.SerializerMethodField()

    class Meta:
        model = Answer
        fields = [
            'id', 'content', 'author', 'question', 'votes', 'is_accepted',
            'is_anonymous', 'created_at', 'updated_at', 'comments',
            'comments_count', 'user_vote'
        ]
        read_only_fields = fields

    def get_comments_count(self, obj):
        return obj.comments.count()

    def get_user_vote(self, obj):
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            vote = obj.answer_votes.filter(user=request.user).first()
            if vote:
                return vote.vote_type
        return None


class AnswerCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Answer
        fields = ['content', 'question', 'is_anonymous']
        extra_kwargs = {
            'question': {'required': True},
        }


class AnswerUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Answer
        fields = ['content', 'is_anonymous']


class AnswerAcceptSerializer(serializers.Serializer):
    is_accepted = serializers.BooleanField()


class AnswerVoteSerializer(serializers.Serializer):
    vote_type = serializers.ChoiceField(choices=Vote.VOTE_TYPES)
```

### 评论序列化器
```python
# qa/serializers/comment.py
from rest_framework import serializers
from qa.models import Comment
from qa.serializers.user import UserSerializer


class CommentSerializer(serializers.ModelSerializer):
    author = UserSerializer(read_only=True)
    reply_to = serializers.PrimaryKeyRelatedField(read_only=True)
    replies = serializers.SerializerMethodField()

    class Meta:
        model = Comment
        fields = ['id', 'content', 'author', 'question', 'answer', 'reply_to', 'created_at', 'replies']
        read_only_fields = fields

    def get_replies(self, obj):
        replies = obj.replies.all()
        return CommentSerializer(replies, many=True, context=self.context).data


class CommentCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Comment
        fields = ['content', 'question', 'answer', 'reply_to']

    def validate(self, data):
        if not data.get('question') and not data.get('answer'):
            raise serializers.ValidationError("评论必须关联问题或回答")
        if data.get('question') and data.get('answer'):
            raise serializers.ValidationError("评论不能同时关联问题和回答")
        return data
```

### 投票序列化器
```python
# qa/serializers/vote.py
from rest_framework import serializers
from qa.models import Vote

class VoteSerializer(serializers.ModelSerializer):
    class Meta:
        model = Vote
        fields = ['id', 'vote_type', 'user', 'question', 'answer', 'created_at']
        read_only_fields = fields
```

### 通知序列化器
```python
# qa/serializers/notification.py
from rest_framework import serializers
from qa.models import Notification
from qa.serializers.user import UserSerializer
from qa.serializers.question import QuestionSerializer
from qa.serializers.answer import AnswerSerializer
from qa.serializers.comment import CommentSerializer


class NotificationSerializer(serializers.ModelSerializer):
    actor = UserSerializer(read_only=True)
    question = QuestionSerializer(read_only=True)
    answer = AnswerSerializer(read_only=True)
    comment = CommentSerializer(read_only=True)

    class Meta:
        model = Notification
        fields = [
            'id', 'notification_type', 'is_read', 'created_at',
            'actor', 'question', 'answer', 'comment'
        ]
        read_only_fields = fields


class NotificationUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Notification
        fields = ['is_read']
```

## 视图

创建视图目录和文件：

```python
# qa/views/__init__.py
from .user import *
from .tag import *
from .question import *
from .answer import *
from .comment import *
from .vote import *
from .notification import *
from .banner import * 
```

### 轮播图视图

```python
# qa/views/banner.py
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticatedOrReadOnly
from qa.models import Banner
from qa.serializers.banner import BannerSerializer

class BannerViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Banner.objects.filter(is_active=True)
    serializer_class = BannerSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    pagination_class = None  # 禁用分页
```

### 用户视图

```python
# qa/views/user.py
from rest_framework import viewsets, status
from rest_framework.permissions import IsAuthenticated
from rest_framework.decorators import action
from rest_framework.response import Response
from django.contrib.auth import get_user_model
from qa.serializers.user import (
    UserSerializer, UserCreateSerializer, UserUpdateSerializer,
    UserFollowSerializer, WxLoginSerializer
)
from qa.services.wx_auth import WxAuthService
from qa.services.jwt import get_tokens_for_user

User = get_user_model()


class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer

    def get_permissions(self):
        if self.action in ['create', 'wx_login']:
            return []
        elif self.action in ['update', 'partial_update', 'destroy', 'follow']:
            return [IsAuthenticated()]
        return super().get_permissions()

    def get_serializer_class(self):
        if self.action == 'create':
            return UserCreateSerializer
        elif self.action in ['update', 'partial_update']:
            return UserUpdateSerializer
        elif self.action == 'follow':
            return UserFollowSerializer
        elif self.action == 'wx_login':
            return WxLoginSerializer
        return super().get_serializer_class()

    @action(detail=False, methods=['get'])
    def me(self, request):
        serializer = self.get_serializer(request.user)
        return Response(serializer.data)

    @action(detail=True, methods=['post'])
    def follow(self, request, pk=None):
        user = self.get_object()
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        action = serializer.validated_data['action']
        if action == 'follow':
            request.user.following_users.add(user)
        else:
            request.user.following_users.remove(user)

        return Response({'status': 'success'})

    @action(detail=False, methods=['post'])
    def wx_login(self, request):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        code = serializer.validated_data['code']
        wx_auth = WxAuthService()
        wx_user_info = wx_auth.get_wx_user_info(code)

        if not wx_user_info:
            return Response({'error': '微信登录失败'}, status=status.HTTP_400_BAD_REQUEST)

        openid = wx_user_info.get('openid')
        user, created = User.objects.get_or_create(wx_openid=openid)

        if created:
            # 新用户，设置默认用户名
            user.username = f'wxuser_{user.id}'
            user.save()

        tokens = get_tokens_for_user(user)
        return Response({
            'user': UserSerializer(user, context=self.get_serializer_context()).data,
            'tokens': tokens
        })
```

### 标签视图
```python
# qa/views/tag.py
from rest_framework import viewsets, filters
from rest_framework.permissions import IsAuthenticatedOrReadOnly
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from qa.models import Tag
from qa.serializers.tag import TagSerializer, TagFollowSerializer


class TagViewSet(viewsets.ModelViewSet):
    queryset = Tag.objects.all()
    serializer_class = TagSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['name']
    search_fields = ['name', 'description']
    ordering_fields = ['name', 'usage_count']
    ordering = ['name']

    def get_serializer_class(self):
        if self.action == 'follow':
            return TagFollowSerializer
        return super().get_serializer_class()

    @action(detail=True, methods=['post'])
    def follow(self, request, pk=None):
        tag = self.get_object()
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        action = serializer.validated_data['action']
        if action == 'follow':
            request.user.following_tags.add(tag)
        else:
            request.user.following_tags.remove(tag)

        return Response({'status': 'success'})

    @action(detail=False, methods=['get'])
    def popular(self, request):
        popular_tags = Tag.objects.order_by('-usage_count')[:10]
        serializer = self.get_serializer(popular_tags, many=True)
        return Response(serializer.data)
```

### 问题视图
```python
# qa/views/question.py
from rest_framework import viewsets, filters
from rest_framework.permissions import IsAuthenticatedOrReadOnly
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from qa.models import Question, Vote, Comment
from qa.serializers import AnswerSerializer, CommentSerializer
from qa.serializers.question import (
    QuestionSerializer, QuestionCreateSerializer,
    QuestionUpdateSerializer, QuestionVoteSerializer
)


class QuestionViewSet(viewsets.ModelViewSet):
    queryset = Question.objects.all().prefetch_related('answers')
    permission_classes = [IsAuthenticatedOrReadOnly]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    # filterset_fields = ['author', 'tags', 'has_accepted_answer']
    filterset_fields = {
        'author': ['exact'],
        'tags__name': ['exact'],  # 修改这里，按标签名称过滤
        'has_accepted_answer': ['exact']
    }
    search_fields = ['title', 'content']
    ordering_fields = ['created_at', 'updated_at', 'views', 'votes']
    ordering = ['-created_at']


    def get_serializer_class(self):
        if self.action == 'create':
            return QuestionCreateSerializer
        elif self.action in ['update', 'partial_update']:
            return QuestionUpdateSerializer
        elif self.action == 'vote':
            return QuestionVoteSerializer
        return QuestionSerializer

    def perform_create(self, serializer):
        serializer.save(author=self.request.user)

    def perform_update(self, serializer):
        serializer.save(author=self.request.user)

    @action(detail=True, methods=['post'])
    def vote(self, request, pk=None):
        question = self.get_object()
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        vote_type = serializer.validated_data['vote_type']
        vote, created = Vote.objects.update_or_create(
            user=request.user,
            question=question,
            defaults={'vote_type': vote_type}
        )

        question.update_votes()
        return Response(QuestionSerializer(question, context=self.get_serializer_context()).data)

    @action(detail=True, methods=['post'], url_path='increment_views')
    def increment_views(self, request, pk=None):
        question = self.get_object()
        question.views += 1
        question.save()
        return Response({'status': 'success'})

    @action(detail=True, methods=['get'], url_path='answers')
    def get_answers(self, request, pk=None):
        """获取特定问题的所有回答"""
        question = self.get_object()
        answers = question.answers.all()
        serializer = AnswerSerializer(answers, many=True, context=self.get_serializer_context())
        return Response(serializer.data)

    @action(detail=True, methods=['get'], url_path='comments')
    def get_comments(self, request, pk=None):
        """获取特定问题的所有评论"""
        question = self.get_object()
        comments = Comment.objects.filter(question=question)
        serializer = CommentSerializer(comments, many=True, context=self.get_serializer_context())
        return Response(serializer.data)

```

### 回答视图
```python
# qa/views/answer.py
from rest_framework import viewsets, status
from rest_framework.permissions import IsAuthenticatedOrReadOnly
from rest_framework.decorators import action
from rest_framework.response import Response
from qa.models import Answer, Vote
from qa.serializers.answer import (
    AnswerSerializer, AnswerCreateSerializer,
    AnswerUpdateSerializer, AnswerAcceptSerializer,
    AnswerVoteSerializer
)


class AnswerViewSet(viewsets.ModelViewSet):
    queryset = Answer.objects.all()
    permission_classes = [IsAuthenticatedOrReadOnly]

    def get_serializer_class(self):
        if self.action == 'create':
            return AnswerCreateSerializer
        elif self.action in ['update', 'partial_update']:
            return AnswerUpdateSerializer
        elif self.action == 'accept':
            return AnswerAcceptSerializer
        elif self.action == 'vote':
            return AnswerVoteSerializer
        return AnswerSerializer

    def perform_create(self, serializer):
        serializer.save(author=self.request.user)

    def perform_update(self, serializer):
        serializer.save(author=self.request.user)

    @action(detail=True, methods=['post'])
    def vote(self, request, pk=None):
        answer = self.get_object()
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        vote_type = serializer.validated_data['vote_type']
        vote, created = Vote.objects.update_or_create(
            user=request.user,
            answer=answer,
            defaults={'vote_type': vote_type}
        )

        answer.update_votes()
        return Response(AnswerSerializer(answer, context=self.get_serializer_context()).data)

    @action(detail=True, methods=['post'])
    def accept(self, request, pk=None):
        answer = self.get_object()
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        if answer.question.author != request.user:
            return Response({'error': '只有问题作者可以采纳回答'}, status=status.HTTP_403_FORBIDDEN)

        is_accepted = serializer.validated_data['is_accepted']
        if is_accepted:
            answer.accept()
        else:
            answer.is_accepted = False
            answer.save()
            answer.question.has_accepted_answer = False
            answer.question.save()

        return Response(AnswerSerializer(answer, context=self.get_serializer_context()).data)
```

### 评论视图
```python
# qa/views/comment.py
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticatedOrReadOnly
from qa.models import Comment
from qa.serializers.comment import CommentSerializer, CommentCreateSerializer


class CommentViewSet(viewsets.ModelViewSet):
    queryset = Comment.objects.all()
    permission_classes = [IsAuthenticatedOrReadOnly]

    def get_serializer_class(self):
        if self.action == 'create':
            return CommentCreateSerializer
        return CommentSerializer

    def perform_create(self, serializer):
        serializer.save(author=self.request.user)
```

### 通知视图
```python
# qa/views/notification.py
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from rest_framework.decorators import action
from rest_framework.response import Response
from qa.models import Notification
from qa.serializers.notification import NotificationSerializer, NotificationUpdateSerializer


class NotificationViewSet(viewsets.ReadOnlyModelViewSet):
    serializer_class = NotificationSerializer
    permission_classes = [IsAuthenticated]

    # 添加 queryset 属性
    queryset = Notification.objects.all()

    def get_queryset(self):
        return self.queryset.filter(recipient=self.request.user).order_by('-created_at')

    def get_serializer_class(self):
        if self.action in ['update', 'partial_update']:
            return NotificationUpdateSerializer
        return super().get_serializer_class()

    @action(detail=False, methods=['get'])
    def unread_count(self, request):
        count = self.get_queryset().filter(is_read=False).count()
        return Response({'count': count})

    @action(detail=False, methods=['post'])
    def mark_all_as_read(self, request):
        updated = self.get_queryset().filter(is_read=False).update(is_read=True)
        return Response({'marked_read': updated})
```

## 服务层

### 微信认证服务
```python
# qa/services/wx_auth.py
import requests
from django.conf import settings

class WxAuthService:
    def __init__(self):
        self.app_id = settings.WX_APP_ID
        self.app_secret = settings.WX_APP_SECRET
        self.login_url = settings.WX_LOGIN_URL
    
    def get_wx_user_info(self, code):
        params = {
            'appid': self.app_id,
            'secret': self.app_secret,
            'js_code': code,
            'grant_type': 'authorization_code'
        }
        
        try:
            response = requests.get(self.login_url, params=params)
            response.raise_for_status()
            return response.json()
        except requests.RequestException:
            return None
```

### JWT服务
```python
# qa/services/jwt.py
from rest_framework_simplejwt.tokens import RefreshToken

def get_tokens_for_user(user):
    refresh = RefreshToken.for_user(user)
    
    return {
        'refresh': str(refresh),
        'access': str(refresh.access_token),
    }
```

## URL路由

### 主URLs
```python
# techqa/urls.py
from django.contrib import admin
from django.conf import settings
from django.conf.urls.static import static
from django.urls import path, include
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView, SpectacularRedocView
from rest_framework.routers import DefaultRouter
from qa.views import (
    UserViewSet, TagViewSet, QuestionViewSet,BannerViewSet,
    AnswerViewSet, CommentViewSet, NotificationViewSet, VoteViewSet
)

router = DefaultRouter()
router.register(r'users', UserViewSet)
router.register(r'tags', TagViewSet)
router.register(r'questions', QuestionViewSet)
router.register(r'answers', AnswerViewSet)
router.register(r'comments', CommentViewSet)
router.register(r'notifications', NotificationViewSet)
router.register(r'votes', VoteViewSet)
router.register(r'banners', BannerViewSet)

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include(router.urls)),
    # path('api/auth/', include('rest_framework.urls', namespace='rest_framework')),
    # OpenAPI生成端点
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    # Swagger UI:
    path('api/swagger/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
    # Redoc UI:
    path('api/redoc/', SpectacularRedocView.as_view(url_name='schema'), name='redoc'),
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

## 信号处理

创建信号处理：

```python
# qa/signals/__init__.py
from .question import *
from .answer import *
from .comment import *
from .vote import *
```

### 问题信号
```python
# qa/signals/question.py
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from qa.models import Question, Notification

@receiver(post_save, sender=Question)
def update_tag_usage(sender, instance, created, **kwargs):
    if created:
        for tag in instance.tags.all():
            tag.usage_count += 1
            tag.save()

@receiver(post_delete, sender=Question)
def decrease_tag_usage(sender, instance, **kwargs):
    for tag in instance.tags.all():
        tag.usage_count -= 1
        tag.save()
```

### 回答信号
```python
# qa/signals/answer.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from qa.models import Answer, Notification

@receiver(post_save, sender=Answer)
def notify_question_author(sender, instance, created, **kwargs):
    if created:
        Notification.objects.create(
            notification_type='question_answered',
            recipient=instance.question.author,
            actor=instance.author,
            question=instance.question,
            answer=instance
        )
    
    if instance.is_accepted:
        Notification.objects.create(
            notification_type='answer_accepted',
            recipient=instance.author,
            actor=instance.question.author,
            question=instance.question,
            answer=instance
        )
```

### 评论信号
```python
# qa/signals/comment.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from qa.models import Comment, Notification

@receiver(post_save, sender=Comment)
def notify_comment_target(sender, instance, created, **kwargs):
    if not created:
        return
    
    recipient = None
    if instance.question:
        recipient = instance.question.author
    elif instance.answer:
        recipient = instance.answer.author
    
    if recipient and recipient != instance.author:
        Notification.objects.create(
            notification_type='answer_commented' if instance.answer else 'question_commented',
            recipient=recipient,
            actor=instance.author,
            question=instance.question,
            answer=instance.answer,
            comment=instance
        )
    
    if instance.reply_to and instance.reply_to.author != instance.author:
        Notification.objects.create(
            notification_type='comment_replied',
            recipient=instance.reply_to.author,
            actor=instance.author,
            question=instance.question,
            answer=instance.answer,
            comment=instance
        )
```

### 投票信号
```python
# qa/signals/vote.py
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from qa.models import Vote

@receiver(post_save, sender=Vote)
def update_reputation_on_vote(sender, instance, created, **kwargs):
    if created:
        target_user = None
        points = 0
        
        if instance.question:
            target_user = instance.question.author
            points = 5 if instance.vote_type == 'up' else -2
        elif instance.answer:
            target_user = instance.answer.author
            points = 10 if instance.vote_type == 'up' else -2
        
        if target_user and target_user != instance.user:
            target_user.reputation += points
            target_user.save()

@receiver(post_delete, sender=Vote)
def revert_reputation_on_vote_delete(sender, instance, **kwargs):
    target_user = None
    points = 0
    
    if instance.question:
        target_user = instance.question.author
        points = -5 if instance.vote_type == 'up' else 2
    elif instance.answer:
        target_user = instance.answer.author
        points = -10 if instance.vote_type == 'up' else 2
    
    if target_user and target_user != instance.user:
        target_user.reputation += points
        target_user.save()
```

### 注册信号
```python
# qa/apps.py
from django.apps import AppConfig

class QaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'qa'
    
    def ready(self):
        import qa.signals
```

## API 请求 URL

```
admin/
api/ ^users/$ [name='user-list']
api/ ^users\.(?P<format>[a-z0-9]+)/?$ [name='user-list']
api/ ^users/me/$ [name='user-me']
api/ ^users/me\.(?P<format>[a-z0-9]+)/?$ [name='user-me']
api/ ^users/wx_login/$ [name='user-wx-login']
api/ ^users/wx_login\.(?P<format>[a-z0-9]+)/?$ [name='user-wx-login']
api/ ^users/(?P<pk>[^/.]+)/$ [name='user-detail']
api/ ^users/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='user-detail']
api/ ^users/(?P<pk>[^/.]+)/follow/$ [name='user-follow']
api/ ^users/(?P<pk>[^/.]+)/follow\.(?P<format>[a-z0-9]+)/?$ [name='user-follow']
api/ ^tags/$ [name='tag-list']
api/ ^tags\.(?P<format>[a-z0-9]+)/?$ [name='tag-list']
api/ ^tags/popular/$ [name='tag-popular']
api/ ^tags/popular\.(?P<format>[a-z0-9]+)/?$ [name='tag-popular']
api/ ^tags/(?P<pk>[^/.]+)/$ [name='tag-detail']
api/ ^tags/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='tag-detail']
api/ ^tags/(?P<pk>[^/.]+)/follow/$ [name='tag-follow']
api/ ^tags/(?P<pk>[^/.]+)/follow\.(?P<format>[a-z0-9]+)/?$ [name='tag-follow']
api/ ^questions/$ [name='question-list']
api/ ^questions\.(?P<format>[a-z0-9]+)/?$ [name='question-list']
api/ ^questions/(?P<pk>[^/.]+)/$ [name='question-detail']
api/ ^questions/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='question-detail']
api/ ^questions/(?P<pk>[^/.]+)/answers/$ [name='question-get-answers']
api/ ^questions/(?P<pk>[^/.]+)/answers\.(?P<format>[a-z0-9]+)/?$ [name='question-get-answers']
api/ ^questions/(?P<pk>[^/.]+)/comments/$ [name='question-get-comments']
api/ ^questions/(?P<pk>[^/.]+)/comments\.(?P<format>[a-z0-9]+)/?$ [name='question-get-comments']
api/ ^questions/(?P<pk>[^/.]+)/increment_views/$ [name='question-increment-views']
api/ ^questions/(?P<pk>[^/.]+)/increment_views\.(?P<format>[a-z0-9]+)/?$ [name='question-increment-views']
api/ ^questions/(?P<pk>[^/.]+)/vote/$ [name='question-vote']
api/ ^questions/(?P<pk>[^/.]+)/vote\.(?P<format>[a-z0-9]+)/?$ [name='question-vote']
api/ ^answers/$ [name='answer-list']
api/ ^answers\.(?P<format>[a-z0-9]+)/?$ [name='answer-list']
api/ ^answers/(?P<pk>[^/.]+)/$ [name='answer-detail']
api/ ^answers/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='answer-detail']
api/ ^answers/(?P<pk>[^/.]+)/accept/$ [name='answer-accept']
api/ ^answers/(?P<pk>[^/.]+)/accept\.(?P<format>[a-z0-9]+)/?$ [name='answer-accept']
api/ ^answers/(?P<pk>[^/.]+)/vote/$ [name='answer-vote']
api/ ^answers/(?P<pk>[^/.]+)/vote\.(?P<format>[a-z0-9]+)/?$ [name='answer-vote']
api/ ^comments/$ [name='comment-list']
api/ ^comments\.(?P<format>[a-z0-9]+)/?$ [name='comment-list']
api/ ^comments/(?P<pk>[^/.]+)/$ [name='comment-detail']
api/ ^comments/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='comment-detail']
api/ ^notifications/$ [name='notification-list']
api/ ^notifications\.(?P<format>[a-z0-9]+)/?$ [name='notification-list']
api/ ^notifications/mark_all_as_read/$ [name='notification-mark-all-as-read']
api/ ^notifications/mark_all_as_read\.(?P<format>[a-z0-9]+)/?$ [name='notification-mark-all-as-read']
api/ ^notifications/unread_count/$ [name='notification-unread-count']
api/ ^notifications/unread_count\.(?P<format>[a-z0-9]+)/?$ [name='notification-unread-count']
api/ ^notifications/(?P<pk>[^/.]+)/$ [name='notification-detail']
api/ ^notifications/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='notification-detail']
api/ ^votes/$ [name='vote-list']
api/ ^votes\.(?P<format>[a-z0-9]+)/?$ [name='vote-list']
api/ ^votes/my_votes/$ [name='vote-my-votes']
api/ ^votes/my_votes\.(?P<format>[a-z0-9]+)/?$ [name='vote-my-votes']
api/ ^votes/(?P<pk>[^/.]+)/$ [name='vote-detail']
api/ ^votes/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='vote-detail']
api/ ^votes/(?P<pk>[^/.]+)/change_vote/$ [name='vote-change-vote']
api/ ^votes/(?P<pk>[^/.]+)/change_vote\.(?P<format>[a-z0-9]+)/?$ [name='vote-change-vote']
api/ ^banners/$ [name='banner-list']
api/ ^banners\.(?P<format>[a-z0-9]+)/?$ [name='banner-list']
api/ ^banners/(?P<pk>[^/.]+)/$ [name='banner-detail']
api/ ^banners/(?P<pk>[^/.]+)\.(?P<format>[a-z0-9]+)/?$ [name='banner-detail']
api/ [name='api-root']
api/ <drf_format_suffix:format> [name='api-root']
api/schema/ [name='schema']
api/swagger/ [name='swagger-ui']
api/redoc/ [name='redoc']
```

## 部署准备

```
pip install gunicorn --break-system-packages

gunicorn techqa.wsgi:application --bind 0.0.0.0:8000 --daemon

pkill gunicorn
```

服务地址：

```
http://localhost:8000/
```

### requirements.txt
```

```

### .env 示例
```

```

### 数据库迁移
```bash
python manage.py makemigrations
python manage.py migrate
```

### 创建超级用户
```bash
python manage.py createsuperuser
admin
123456@admin.com
123456
```

# 微信小程序页面设计 - 技术问答平台

基于提供的Django后端设计，设计微信小程序，对接Django后端的请求API URL

## 首页

**功能**：
- 轮播图展示（Banner）
- 热门问题列表
- 搜索框
- 分类标签入口

**页面元素**：
- 顶部导航栏（包含搜索图标）
- 轮播图区域
- 问题列表（标题、作者、点赞数、回答数、标签）
- 底部Tab栏（首页、提问、消息、我的）

## 问题详情页

**功能**：
- 问题完整内容展示
- 回答列表
- 点赞/反对功能
- 回答功能
- 采纳最佳答案

**页面元素**：
- 问题标题和内容区
- 作者信息（头像、用户名）
- 标签展示
- 投票按钮（赞同/反对）
- 回答列表（按投票数排序，最佳回答置顶）
- 回答输入框
- 底部操作栏（写回答、收藏）

## 提问页面

**功能**：
- 发布新问题
- 添加标签
- 匿名提问选项

**页面元素**：
- 标题输入框
- 内容编辑器（支持Markdown）
- 标签选择器
- 匿名提问开关
- 发布按钮

## 个人中心页

**功能**：
- 用户信息展示
- 我的问题/回答/收藏
- 关注管理
- 设置

**页面元素**：
- 用户头像和基本信息
- 数据统计（提问数、回答数、获赞数）
- 功能入口列表（我的问题、我的回答、我的收藏、关注列表、设置）

## 消息通知页

**功能**：
- 系统通知展示
- 消息标记已读
- 全部标记已读

**页面元素**：
- 通知列表（类型图标、内容摘要、时间）
- 未读标记
- 全部已读按钮

## 搜索与标签页

**功能**：
- 关键词搜索
- 按标签筛选问题
- 热门标签展示

**页面元素**：
- 搜索框
- 热门标签云
- 搜索结果列表

## 登录页面

**功能**：
- 微信一键登录
- 用户协议确认

**页面元素**：
- 平台Logo
- 微信登录按钮
- 用户协议链接

## 页面交互流程

1. **游客流程**：
   - 首页浏览 → 查看问题详情 → 触发登录 → 登录后返回

2. **用户提问流程**：
   - 点击底部"提问" → 填写问题 → 发布 → 跳转到问题详情

3. **回答流程**：
   - 问题详情页 → 底部写回答 → 提交 → 刷新回答列表

4. **消息通知流程**：
   - 收到回答/评论 → 消息页显示 → 点击跳转到对应内容

## 技术实现

1. **页面框架**：
   - 使用微信小程序原生框架
2. **数据交互**：
   - 使用wx.request对接DRF API

## 微信小程序代码（粘贴了部分）

app.json

```json
{
  "pages": [
    "pages/index/index",
    "pages/question/question",
    "pages/ask/ask",
    "pages/user/user",
    "pages/user/questions",
    "pages/user/answers",
    "pages/user/votes",
    "pages/notifications/notifications",
    "pages/about/about",
    "pages/search/search"
  ],
  "window": {
    "backgroundColor": "#F6F6F6",
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#C00000",
    "navigationBarTitleText": "技术问答平台",
    "navigationBarTextStyle": "white",
    "enablePullDownRefresh": true
  },
  "tabBar": {
    "color": "#999",
    "selectedColor": "#C00000",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/home.png",
        "selectedIconPath": "images/home.png"
      },
      {
        "pagePath": "pages/ask/ask",
        "text": "提问",
        "iconPath": "images/ask.png",
        "selectedIconPath": "images/ask.png"
      },
      {
        "pagePath": "pages/notifications/notifications",
        "text": "消息",
        "iconPath": "images/notification.png",
        "selectedIconPath": "images/notification.png"
      },
      {
        "pagePath": "pages/user/user",
        "text": "我的",
        "iconPath": "images/user.png",
        "selectedIconPath": "images/user.png"
      }
    ]
  },
  "style": "v2",
  "componentFramework": "glass-easel",
  "sitemapLocation": "sitemap.json",
  "lazyCodeLoading": "requiredComponents"
}
```

app.js 自动登录

```js
// app.js
App({
    onLaunch: function () {
        this.wxLogin();
    },

    wxLogin: function () {
        // 微信登录
        wx.login({
            success: res => {
                if (res.code) {
                    this.getTokenFromBackend(res.code);
                } else {
                    wx.showToast({
                        title: '登录失败！' + res.errMsg,
                    })
                }
            }
        });
    },

    getTokenFromBackend: function (code) {
        wx.request({
            url: 'http://localhost:8000/api/users/wx_login/',
            method: 'POST',
            data: {
                code: code
            },
            success: res => {
                if (res.data && res.data.user && res.data.tokens) {
                    this.globalData.userInfo = res.data.user;
                    this.globalData.tokens = res.data.tokens;

                    wx.setStorageSync('userInfo', res.data.user);
                    wx.setStorageSync('tokens', res.data.tokens);

                    wx.showToast({
                        title: '登录成功',
                    })
                }
            },
            fail: err => {
                wx.showToast({
                    title: '登录失败',
                })
            }
        });
    },

    globalData: {
        userInfo: null,
        tokens: null
    }
});
```

### Utils

request.js

```js
// utils/request.js
const BASE_URL = 'http://localhost:8000/api/';

const request = (url, method, data = {}, isAuth = true) => {
  return new Promise((resolve, reject) => {
    const header = {
      'Content-Type': 'application/json'
    };
    
    if (isAuth) {
      const tokens = wx.getStorageSync('tokens');
      if (tokens && tokens.access) {
        header['Authorization'] = `Bearer ${tokens.access}`;
      }
    }
    
    wx.request({
      url: BASE_URL + url,
      method: method,
      data: data,
      header: header,
      success: (res) => {
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data);
        } else {
          reject(res.data);
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
};

// 用户相关API
export const wxLogin = (code) => request('users/wx_login/', 'POST', { code }, false);
export const getUserInfo = (userId) => request(`users/${userId}/`, 'GET');
export const updateUserInfo = (userId, data) => request(`users/${userId}/`, 'PATCH', data);
export const followUser = (userId, action) => request(`users/${userId}/follow/`, 'POST', { action });

// 问题相关API
// export const getQuestions = (params) => request('questions/', 'GET', params);
export const getQuestions = (params) => {
    // 如果传入了tag_name参数，转换为tags__name
    if (params.tag_name) {
      params.tags__name = params.tag_name;
      delete params.tag_name;
    }
    return request('questions/', 'GET', params);
  };
export const getQuestionDetail = (questionId) => request(`questions/${questionId}/`, 'GET');
export const createQuestion = (data) => request('questions/', 'POST', data);
export const updateQuestion = (questionId, data) => request(`questions/${questionId}/`, 'PATCH', data);
export const voteQuestion = (questionId, voteType) => request(`questions/${questionId}/vote/`, 'POST', { vote_type: voteType });
export const incrementViews = (questionId) => request(`questions/${questionId}/increment_views/`, 'POST');

// 投票相关
export const getMyVote = () => request(`votes/my_votes/`, 'GET');

// 回答相关API
export const getAnswers = (questionId) => request(`questions/${questionId}/answers/`, 'GET');
export const getUserAnswers = (params) => request('answers/', 'GET', params);
export const createAnswer = (data) => request('answers/', 'POST', data);
export const updateAnswer = (answerId, data) => request(`answers/${answerId}/`, 'PATCH', data);
export const voteAnswer = (answerId, voteType) => request(`answers/${answerId}/vote/`, 'POST', { vote_type: voteType });
export const acceptAnswer = (answerId, isAccepted) => request(`answers/${answerId}/accept/`, 'POST', { is_accepted: isAccepted });

// 评论相关API
export const getComments = (questionId) => request(`questions/${questionId}/comments/`, 'GET');
export const createComment = (data) => request('comments/', 'POST', data);

// 标签相关API
export const getTags = () => request('tags/', 'GET');
export const getPopularTags = () => request('tags/popular/', 'GET');
export const followTag = (tagId, action) => request(`tags/${tagId}/follow/`, 'POST', { action });

// 通知相关API
export const getNotifications = () => request('notifications/', 'GET');
export const getUnreadCount = () => request('notifications/unread_count/', 'GET');
export const markAllAsRead = () => request('notifications/mark_all_as_read/', 'POST');

// 轮播图API
export const getBanners = () => request('banners/', 'GET');

export default {
  wxLogin,
  getUserInfo,
  updateUserInfo,
  followUser,
  getQuestions,
  getQuestionDetail,
  createQuestion,
  updateQuestion,
  voteQuestion,
  incrementViews,
  getAnswers,
  createAnswer,
  updateAnswer,
  voteAnswer,
  acceptAnswer,
  getComments,
  createComment,
  getTags,
  getPopularTags,
  followTag,
  getNotifications,
  getUnreadCount,
  markAllAsRead,
  getBanners,
  getMyVote,
  getUserAnswers
};
```

### Index

index.js

```js
import { getQuestions, getBanners, getPopularTags } from '../../utils/request';

Page({
  data: {
    banners: [],
    questions: [],
    popularTags: [],
    isLoading: true,
    page: 1,
    pageSize: 10,
    hasMore: true,
    isFetching: false,  // 请求锁
    error: null        // 错误信息
  },

  onLoad() {
    this.loadData();
  },

  onPullDownRefresh() {
    this.setData({
      page: 1,
      hasMore: true,
      error: null
    });
    this.loadData(true);
  },

  onReachBottom() {
    if (this.data.hasMore && !this.data.isLoading) {
      this.loadMoreData();
    }
  },

  loadData(isRefresh = false) {
    const oldQuestions = this.data.questions;
    this.setData({ 
      isLoading: true,
      page: isRefresh ? 1 : this.data.page,
      hasMore: true,
      error: null
    });
    
    Promise.all([
      getBanners(),
      getQuestions({ ordering: '-created_at', page: this.data.page, page_size: this.data.pageSize }),
      getPopularTags()
    ]).then(([banners, questions, tags]) => {
      this.setData({
        banners: banners.results || banners,
        questions: questions.results || questions,
        popularTags: tags,
        isLoading: false
      });
      if (isRefresh) {
        wx.stopPullDownRefresh();
      }
    }).catch(err => {
      console.error('加载数据失败:', err);
      this.setData({ 
        isLoading: false,
        error: '加载失败，请重试'
      });
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
      if (isRefresh) {
        wx.stopPullDownRefresh();
      }
    });
  },

  loadMoreData() {
    if (!this.data.hasMore || this.data.isFetching) return;
    
    this.setData({ 
      isLoading: true,
      isFetching: true
    });
    
    const nextPage = this.data.page + 1;
    
    getQuestions({ ordering: '-created_at', page: nextPage, page_size: this.data.pageSize })
      .then(res => {
        const newQuestions = res.results || [];
        this.setData({
          questions: [...this.data.questions, ...newQuestions],
          page: nextPage,
          hasMore: newQuestions.length >= this.data.pageSize,
          isLoading: false,
          isFetching: false
        });
      })
      .catch(err => {
        this.setData({ 
          isLoading: false,
          isFetching: false,
          error: '没有更多了'
        });
        wx.showToast({
          title: '没有更多了',
          icon: 'none'
        });
      });
  },

  navigateToSearch() {
    wx.navigateTo({
      url: '/pages/search/search'
    });
  },

  navigateToQuestion(e) {
    const id = e.currentTarget.dataset.id;
    wx.navigateTo({
      url: `/pages/question/question?id=${id}`
    });
  },

  navigateToTag(e) {
    const name = e.currentTarget.dataset.name;
    wx.navigateTo({
      url: `/pages/search/search?tag=${name}`
    });
  },

  onAskTap(e) {
    // wx.navigateTo({
    //   url: `/pages/ask/ask`
    // });
  }
});
```

index.wxml

```html
<view class="container">
    <!-- 搜索框 -->
    <view class="search-bar" bindtap="navigateToSearch">
        <icon type="search" size="16" color="#999"></icon>
        <text class="search-text">搜索问题或标签</text>
    </view>

    <!-- 轮播图 -->
    <swiper class="banner" indicator-dots autoplay interval="3000" duration="500">
        <block wx:for="{{banners}}" wx:key="id">
            <swiper-item>
                <image src="{{item.image_url}}" mode="aspectFill" class="banner-image"></image>
            </swiper-item>
        </block>
    </swiper>

    <!-- 热门标签 -->
    <view class="section">
        <view class="section-title">热门标签</view>
        <view class="tags">
            <block wx:for="{{popularTags}}" wx:key="id">
                <view class="tag" bindtap="navigateToTag" data-name="{{item.name}}">{{item.name}}</view>
            </block>
        </view>
    </view>

    <!-- 问题列表 -->
    <view class="section">
        <view class="section-title">最新问题</view>
        <block wx:for="{{questions}}" wx:key="id">
            <view class="question-card" bindtap="navigateToQuestion" data-id="{{item.id}}">
                <view class="question-title">{{item.title}}</view>
                <view class="question-meta">
                    <view class="question-metaq">
                        <view class="avatar-con">
                            <image class="avatar" src="{{item.author.avatar || '/images/default-avatar.png'}}"></image>
                            <text class="username">{{item.author.username}}</text>
                        </view>
                        <text>{{item.views}} 浏览</text>
                        <text>{{item.answers_count}} 回答</text>
                    </view>
                    <text>{{item.created_at}} 发布</text>
                </view>
                <view class="question-tags">
                    <block wx:for="{{item.tags.slice(0, 3)}}" wx:key="id">
                        <text class="tag">{{item.name}}</text>
                    </block>
                </view>
            </view>
        </block>

        <!-- 加载状态 -->
        <view wx:if="{{isLoading && page > 1}}" class="loading">加载中...</view>
        <view wx:if="{{error}}" class="error no-more">{{error}}</view>
        <view wx:if="{{!hasMore && questions.length > 0}}" class="no-more">没有更多了</view>
        <view wx:if="{{questions.length === 0 && !isLoading}}" class="empty">暂无问题</view>
    </view>

    <!-- 提问按钮 -->
    <!-- <view class="fab" bindtap="onAskTap">
        <image src="/images/add.png" class="fab-icon"></image>
    </view> -->
</view>
```

index.wxss

```css
/* pages/index/index.wxss */
.search-bar {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background: #fff;
    border-radius: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.search-text {
    margin-left: 10px;
    color: #999;
    font-size: 14px;
}

.banner {
    height: 150px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 15px;
}

.banner-image {
    width: 100%;
    height: 100%;
}

.section {
    margin-bottom: 20px;
}

.section-title {
    padding: 0 12px;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
}

.tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.tag {
    padding: 4px 10px;
    background: #f0f0f0;
    border-radius: 15px;
    font-size: 12px;
    color: #666;
}

.question-card {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.question-title {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
}

.question-meta {
    display: flex;
    font-size: 12px;
    color: #999;
    margin-bottom: 8px;
}

.question-meta text {
    margin-right: 10px;
}

.question-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.loading,
.no-more {
    text-align: center;
    padding: 10px;
    color: #999;
    font-size: 14px;
}

.fab {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 50px;
  height: 50px;
  background-color: #1890ff;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.fab-icon {
  width: 24px;
  height: 24px;
}
```

### Question

question.js

```js
import {
    getQuestionDetail,
    getAnswers,
    getComments,
    createAnswer,
    createComment,
    voteAnswer,
    acceptAnswer,
    incrementViews,
    voteQuestion
} from '../../utils/request';

// 引入工具函数
import { formatDate } from '../../utils/dateUtils';

Page({
    data: {
        question: null,
        answers: [],
        comments: [],
        newAnswerContent: '',
        newCommentContent: '',
        loading: true,
        isOwner: false,
        activeTab: 'answers', // 'answers' or 'comments'
        replyTo: null, // 回复的评论ID
        currentPage: 1,
        pageSize: 10,
        hasMore: true
    },
    
    onLoad(options) {
        const questionId = options.id;
        this.setData({ questionId });
        this.loadQuestionDetail(questionId);
        this.loadAnswers(questionId);
        this.loadComments(questionId);

        // 增加浏览量
        incrementViews(questionId);
    },

    loadQuestionDetail(questionId) {
        getQuestionDetail(questionId).then(res => {
            const userInfo = wx.getStorageSync('userInfo');
            const isOwner = userInfo && userInfo.id === res.author.id;

            this.setData({
                question: res,
                isOwner,
                loading: false
            });
        }).catch(err => {
            console.error('加载问题详情失败:', err);
            wx.showToast({
                title: '加载失败',
                icon: 'none'
            });
            this.setData({ loading: false });
        });
    },

    loadAnswers(questionId) {
        getAnswers(questionId, {
            page: this.data.currentPage,
            page_size: this.data.pageSize
        }).then(res => {
            const answers = res.results || res;
            this.setData({
                answers,
                hasMore: answers.length >= this.data.pageSize
            });
        }).catch(err => {
            console.error('加载回答失败:', err);
            wx.showToast({
                title: '加载回答失败',
                icon: 'none'
            });
        });
    },

    loadComments(questionId) {
        getComments(questionId).then(res => {
            const comments = res.results || res;
            this.setData({ comments });
        }).catch(err => {
            console.error('加载评论失败:', err);
            wx.showToast({
                title: '加载评论失败',
                icon: 'none'
            });
        });
    },

    onReachBottom() {
        if (this.data.hasMore && this.data.activeTab === 'answers') {
            this.setData({
                currentPage: this.data.currentPage + 1
            });
            this.loadAnswers(this.data.questionId);
        }
    },

    switchTab(e) {
        const tab = e.currentTarget.dataset.tab;
        this.setData({ activeTab: tab });
    },

    handleAnswerInput(e) {
        this.setData({ newAnswerContent: e.detail.value });
    },

    handleCommentInput(e) {
        this.setData({ newCommentContent: e.detail.value });
    },

    submitAnswer() {
        if (!this.data.newAnswerContent.trim()) {
            wx.showToast({
                title: '请输入回答内容',
                icon: 'none'
            });
            return;
        }

        const data = {
            content: this.data.newAnswerContent,
            question: this.data.questionId
        };

        createAnswer(data).then(res => {
            wx.showToast({
                title: '回答成功',
                icon: 'success'
            });
            this.setData({ newAnswerContent: '' });
            this.loadAnswers(this.data.questionId);
        }).catch(err => {
            console.error('提交回答失败:', err);
            wx.showToast({
                title: '回答失败',
                icon: 'none'
            });
        });
    },

    submitComment() {
        if (!this.data.newCommentContent.trim()) {
            wx.showToast({
                title: '请输入评论内容',
                icon: 'none'
            });
            return;
        }

        const data = {
            content: this.data.newCommentContent,
            question: this.data.questionId,
            reply_to: this.data.replyTo
        };

        createComment(data).then(res => {
            wx.showToast({
                title: '评论成功',
                icon: 'success'
            });
            this.setData({
                newCommentContent: '',
                replyTo: null
            });
            this.loadComments(this.data.questionId);
        }).catch(err => {
            console.error('提交评论失败:', err);
            wx.showToast({
                title: '评论失败',
                icon: 'none'
            });
        });
    },

    voteQuestion(e) {
        const questionId = e.currentTarget.dataset.id;
        const voteType = e.currentTarget.dataset.type;

        voteQuestion(questionId, voteType).then(res => {
            // 重新加载问题详情以更新投票状态
            this.loadQuestionDetail(this.data.questionId);
            wx.showToast({
                title: '投票成功',
                icon: 'success'
            });
        }).catch(err => {
            console.error('投票失败:', err);
            wx.showToast({
                title: '投票失败',
                icon: 'none'
            });
        });
    },

    voteAnswer(e) {
        const answerId = e.currentTarget.dataset.id;
        const voteType = e.currentTarget.dataset.type;

        voteAnswer(answerId, voteType).then(res => {
            this.loadAnswers(this.data.questionId);
        }).catch(err => {
            console.error('投票失败:', err);
            wx.showToast({
                title: '投票失败',
                icon: 'none'
            });
        });
    },

    acceptAnswer(e) {
        const answerId = e.currentTarget.dataset.id;
        const isAccepted = e.currentTarget.dataset.accept === 'true';

        acceptAnswer(answerId, isAccepted).then(res => {
            this.loadAnswers(this.data.questionId);
            this.loadQuestionDetail(this.data.questionId);
            wx.showToast({
                title: isAccepted ? '已采纳回答' : '已取消采纳',
                icon: 'success'
            });
        }).catch(err => {
            console.error('采纳回答失败:', err);
            wx.showToast({
                title: '操作失败',
                icon: 'none'
            });
        });
    },

    replyComment(e) {
        const commentId = e.currentTarget.dataset.id;
        const username = e.currentTarget.dataset.username;

        this.setData({
            replyTo: commentId,
            newCommentContent: `@${username} `
        });
    }
});
```

question.json

```json
{
  "usingComponents": {},
  "enablePullDownRefresh": true
}
```

question.wxml

```html
<view class="container">
    <!-- 问题详情 -->
    <view class="question-section" wx:if="{{question}}">
        <view class="question-title">{{question.title}}</view>

        <view class="question-meta">
            <view class="author-info">
                <image class="avatar" src="{{question.author.avatar || '/images/default-avatar.png'}}"></image>
                <text class="username">{{question.author.username}}</text>
            </view>
            <view class="meta-info">
                <text>{{question.views}} 浏览</text>
                <text>{{question.answers_count}} 回答</text>
                <!-- <text>{{question.votes}} 赞</text> -->
            </view>

            <!-- 对问题进行 vote -->
            <!-- <view class="vote-buttons">
                <button class="mbutton1 vote-btn up {{question.user_vote === 'up' ? 'active' : ''}}" bindtap="voteQuestion" data-id="{{question.id}}" data-type="up">
                    赞同 {{question.votes > 0 ? question.votes : ''}}
                </button>
                <button class="mbutton1 vote-btn down {{question.user_vote === 'down' ? 'active' : ''}}" bindtap="voteQuestion" data-id="{{question.id}}" data-type="down">
                    反对
                </button>
            </view> -->
        </view>

        <view class="question-content">{{question.content}}</view>

        <view class="question-tags">
            <block wx:for="{{question.tags}}" wx:key="id">
                <text class="tag">{{item.name}}</text>
            </block>
        </view>
    </view>

    <!-- 选项卡 -->
    <view class="tabs">
        <view class="tab {{activeTab === 'answers' ? 'active' : ''}}" bindtap="switchTab" data-tab="answers">
            回答({{question ? question.answers_count : 0}})
        </view>
        <view class="tab {{activeTab === 'comments' ? 'active' : ''}}" bindtap="switchTab" data-tab="comments">
            评论({{comments.length}})
        </view>
    </view>

    <!-- 回答列表 -->
    <view class="content-section" wx:if="{{activeTab === 'answers'}}">
        <block wx:for="{{answers}}" wx:key="id">
            <view class="answer-item {{item.is_accepted ? 'accepted' : ''}}">
                <view class="answer-header">
                    <image class="avatar" src="{{item.author.avatar || '/images/default-avatar.png'}}"></image>
                    <text class="username">{{item.author.username}}</text>
                    <text class="time">{{item.created_at}}</text>
                </view>

                <view class="answer-content">{{item.content}}</view>

                <view class="answer-footer">
                    <view class="mbutton vote-buttons">
                        <button class="vote-btn up {{item.user_vote === 'up' ? 'active' : ''}}" bindtap="voteAnswer" data-id="{{item.id}}" data-type="up">
                            赞同 {{item.votes > 0 ? item.votes : ''}}
                        </button>
                        <button class="mbutton vote-btn down {{item.user_vote === 'down' ? 'active' : ''}}" bindtap="voteAnswer" data-id="{{item.id}}" data-type="down">
                            反对
                        </button>
                    </view>

                    <!-- 问题作者可以采纳回答 -->
                    <!-- <view wx:if="{{isOwner}}">
                        <button class="mbutton accept-btn {{item.is_accepted ? 'active' : ''}}" bindtap="acceptAnswer" data-id="{{item.id}}" data-accept="{{!item.is_accepted}}">
                            {{item.is_accepted ? '已采纳' : '采纳'}}
                        </button>
                    </view> -->
                </view>
            </view>
        </block>

        <view wx:if="{{loading}}" class="loading">加载中...</view>
        <view wx:if="{{!hasMore && answers.length > 0}}" class="no-more">没有更多了</view>
        <view wx:if="{{answers.length === 0 && !loading}}" class="empty">暂无回答</view>
    </view>

    <!-- 评论列表 -->
    <view class="content-section" wx:if="{{activeTab === 'comments'}}">
        <block wx:for="{{comments}}" wx:key="id">
            <view class="comment-item">
                <image class="avatar" src="{{item.author.avatar || '/images/default-avatar.png'}}"></image>
                <view class="comment-content">
                    <view class="comment-header">
                        <text class="username">{{item.author.username}}</text>
                        <text class="time">{{item.created_at}}</text>
                    </view>
                    <view class="comment-text">
                        <text wx:if="{{item.reply_to}}">回复 @{{item.reply_to.author.username}}: </text>
                        {{item.content}}
                    </view>
                    <view class="comment-actions">
                        <text class="reply-btn" bindtap="replyComment" data-id="{{item.id}}" data-username="{{item.author.username}}">回复</text>
                    </view>

                    <!-- 回复列表 -->
                    <block wx:if="{{item.replies && item.replies.length > 0}}">
                        <view class="replies">
                            <block wx:for="{{item.replies}}" wx:key="id">
                                <view class="reply-item">
                                    <image class="avatar" src="{{item.author.avatar || '/images/default-avatar.png'}}"></image>
                                    <view class="reply-content">
                                        <view class="reply-header">
                                            <text class="username">{{item.author.username}}</text>
                                            <text class="time">{{item.created_at}}</text>
                                        </view>
                                        <view class="reply-text">
                                            回复 @{{item.reply_to.author.username}}: {{item.content}}
                                        </view>
                                        <view class="comment-actions">
                                            <text class="reply-btn" bindtap="replyComment" data-id="{{item.id}}" data-username="{{item.author.username}}">回复</text>
                                        </view>
                                    </view>
                                </view>
                            </block>
                        </view>
                    </block>
                </view>
            </view>
        </block>

        <view wx:if="{{comments.length === 0 && !loading}}" class="empty">暂无评论</view>
    </view>

    <!-- 回答输入框 -->
    <view class="input-section" wx:if="{{activeTab === 'answers'}}">
        <textarea placeholder="写下你的回答..." value="{{newAnswerContent}}" bindinput="handleAnswerInput"></textarea>
        <button class="submit-btn" bindtap="submitAnswer">提交回答</button>
    </view>

    <!-- 评论输入框 -->
    <view class="input-section" wx:if="{{activeTab === 'comments'}}">
        <textarea placeholder="{{replyTo ? '回复 @' + replyTo : '写下你的评论...'}}" value="{{newCommentContent}}" bindinput="handleCommentInput"></textarea>
        <button class="submit-btn" bindtap="submitComment">提交评论</button>
    </view>
</view>
```

question.wxss

```css
/* pages/question/question.wxss */
.container {
    padding: 15px;
    padding-bottom: 100px;
}

.mbutton {
    width: 120px !important;
}

.mbutton1 {
    width: 60px !important;
}

.question-section {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.question-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
}

.question-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 12px;
    color: #999;
}

.author-info {
    display: flex;
    align-items: center;
}

.avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 8px;
}

.username {
    margin-right: 10px;
}

.meta-info text {
    margin-left: 10px;
}

.question-content {
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 10px;
    color: #333;
}

.question-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.tag {
    padding: 2px 8px;
    background: #f0f0f0;
    border-radius: 12px;
    font-size: 12px;
    color: #666;
}

.tabs {
    display: flex;
    border-bottom: 1px solid #eee;
    margin-bottom: 15px;
}

.tab {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    font-size: 14px;
    color: #666;
}

.tab.active {
    color: #1890ff;
    border-bottom: 2px solid #1890ff;
}

.content-section {
    margin-bottom: 200px;
}

.answer-item {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.answer-item.accepted {
    border-left: 3px solid #52c41a;
}

.answer-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.answer-content {
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 10px;
    color: #333;
}

.answer-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vote-buttons {
    display: flex;
    gap: 10px;
}

.vote-btn {
    font-size: 12px;
    padding: 0 10px;
    height: 24px;
    line-height: 24px;
    border-radius: 12px;
    background: #f5f5f5;
    color: #666;
    border: none;
}

.vote-btn.up.active {
    background: #e6f7ff;
    color: #1890ff;
}

.vote-btn.down.active {
    background: #fff1f0;
    color: #f5222d;
}

.accept-btn {
    font-size: 12px;
    padding: 0 10px;
    height: 24px;
    line-height: 24px;
    border-radius: 12px;
    background: #f5f5f5;
    color: #666;
    border: none;
}

.accept-btn.active {
    background: #f6ffed;
    color: #52c41a;
}

.comment-item {
    display: flex;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.comment-content {
    flex: 1;
    margin-left: 10px;
}

.comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 12px;
    color: #999;
}

.comment-header .username {
    margin-right: 10px;
    color: #1890ff;
}

.comment-text {
    font-size: 14px;
    line-height: 1.5;
    color: #333;
}

.comment-actions {
    margin-top: 5px;
}

.reply-btn {
    font-size: 12px;
    color: #1890ff;
}

.replies {
    margin-top: 10px;
    padding-left: 10px;
    border-left: 1px dashed #eee;
}

.reply-item {
    display: flex;
    margin-bottom: 10px;
}

.reply-content {
    flex: 1;
    margin-left: 10px;
}

.reply-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 12px;
    color: #999;
}

.reply-header .username {
    margin-right: 10px;
    color: #1890ff;
}

.reply-text {
    font-size: 14px;
    line-height: 1.5;
    color: #333;
}

.input-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid #eee;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.input-section textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
    font-size: 14px;
    margin-bottom: 10px;
}

.submit-btn {
    background: #1890ff;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    height: 36px;
    line-height: 36px;
}

.loading,
.no-more,
.empty {
    text-align: center;
    padding: 15px;
    color: #999;
    font-size: 14px;
}
```

### Ask

ask.js

```js
// pages/ask/ask.js
import { getTags, createQuestion } from '../../utils/request';

Page({
    data: {
        title: '',
        content: '',
        selectedTags: [],
        allTags: [],
        newTagName: '',
        isAnonymous: false,
        isSubmitting: false
    },

    onLoad() {
        this.loadAllTags();
    },

    loadAllTags() {
        getTags().then(res => {
            this.setData({
                allTags: res.results || res
            });
        }).catch(err => {
            console.error('加载标签失败:', err);
            wx.showToast({
                title: '加载标签失败',
                icon: 'none'
            });
        });
    },

    onTitleInput(e) {
        this.setData({ title: e.detail.value });
    },

    onContentInput(e) {
        this.setData({ content: e.detail.value });
    },

    onTagSelect(e) {
        const index = e.detail.value;
        const selectedTag = this.data.allTags[index];

        // 检查是否已选择
        const isSelected = this.data.selectedTags.some(tag => tag.id === selectedTag.id);
        if (!isSelected) {
            this.setData({
                selectedTags: [...this.data.selectedTags, selectedTag]
            });
        }
    },

    onNewTagInput(e) {
        this.setData({ newTagName: e.detail.value });
    },

    addNewTag() {
        const newTagName = this.data.newTagName.trim();
        if (!newTagName) return;

        // 检查是否已存在
        const existingTag = this.data.allTags.find(tag =>
            tag.name.toLowerCase() === newTagName.toLowerCase()
        );

        if (existingTag) {
            // 已存在，直接添加
            const isSelected = this.data.selectedTags.some(tag => tag.id === existingTag.id);
            if (!isSelected) {
                this.setData({
                    selectedTags: [...this.data.selectedTags, existingTag],
                    newTagName: ''
                });
            }
        } else {
            // 新标签，添加到选择列表
            const newTag = {
                id: `new_${Date.now()}`,
                name: newTagName
            };
            this.setData({
                selectedTags: [...this.data.selectedTags, newTag],
                newTagName: ''
            });
        }
    },

    removeTag(e) {
        const tagId = e.currentTarget.dataset.id;
        this.setData({
            selectedTags: this.data.selectedTags.filter(tag => tag.id !== tagId)
        });
    },

    onAnonymousChange(e) {
        this.setData({ isAnonymous: e.detail.value });
    },

    submitQuestion() {
        if (!((this.data.title != '') && (this.data.content != ''))) {
            wx.showToast({
                title: '请填写标题和内容',
                icon: 'none'
            });
            return;
        }

        this.setData({ isSubmitting: true });

        const tagNames = this.data.selectedTags.map(tag => tag.name);
        const data = {
            title: this.data.title,
            content: this.data.content,
            tag_names: tagNames,
            is_anonymous: this.data.isAnonymous
        };

        createQuestion(data)
            .then(res => {
                wx.showToast({
                    title: '提问成功',
                    icon: 'success'
                });

                // 返回首页并刷新
                setTimeout(() => {
                    wx.switchTab({
                        url: '/pages/index/index'
                    });
                }, 1500);

                // 清除数据
                this.setData({
                    title: '',
                    content: '',
                    selectedTags: [],
                    newTagName: ''
                })
            })
            .catch(err => {
                console.error('提交问题失败:', err);
                wx.showToast({
                    title: '提问失败',
                    icon: 'none'
                });
            })
            .finally(() => {
                this.setData({ isSubmitting: false });
            });
    },

    get canSubmit() {
        return (this.data.title != '') && (this.data.content != '');
    }
});
```

ask.wxml

```html
<!-- pages/ask/ask.wxml -->
<view class="container">
  <!-- 标题输入 -->
  <view class="form-item">
    <input 
      placeholder="请输入问题标题（必填）" 
      value="{{title}}" 
      bindinput="onTitleInput"
      maxlength="100"
    />
  </view>
  
  <!-- 内容输入 -->
  <view class="form-item">
    <textarea 
      placeholder="请输入问题详情（必填）" 
      value="{{content}}" 
      bindinput="onContentInput"
      auto-height
    />
  </view>
  
  <!-- 标签选择 -->
  <view class="form-item">
    <picker 
      mode="selector" 
      range="{{allTags}}" 
      range-key="name" 
      bindchange="onTagSelect"
    >
      <view class="picker">选择标签（可选）</view>
    </picker>
    <view class="tags-container">
      <block wx:for="{{selectedTags}}" wx:key="id">
        <view class="tag">
          {{item.name}}
          <icon type="clear" size="12" bindtap="removeTag" data-id="{{item.id}}"/>
        </view>
      </block>
    </view>
    <input 
      placeholder="或输入新标签，回车添加" 
      value="{{newTagName}}" 
      bindinput="onNewTagInput"
      bindconfirm="addNewTag"
      maxlength="20"
    />
  </view>
  
  <!-- 匿名选项 -->
  <!-- <view class="form-item">
    <switch 
      checked="{{isAnonymous}}" 
      bindchange="onAnonymousChange"
    />
    <text>匿名提问</text>
  </view> -->
  
  <!-- 提交按钮 -->
  <button 
    type="primary" 
    bindtap="submitQuestion"
    loading="{{isSubmitting}}"
  >
    提交问题
  </button>
</view>
```

ask.wxss

```css
/* pages/ask/ask.wxss */
.container {
    padding: 20px;
  }
  
  .form-item {
    margin-bottom: 20px;
  }
  
  .form-item input,
  .form-item textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  
  .form-item textarea {
    min-height: 150px;
  }
  
  .picker {
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  
  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
  }
  
  .tag {
    display: flex;
    align-items: center;
    padding: 4px 10px;
    background: #f0f0f0;
    border-radius: 15px;
    font-size: 12px;
    color: #666;
  }
  
  switch {
    margin-right: 10px;
  }
  
  button {
    margin-top: 20px;
  }
```

### Notifications

notifications.js

```js
// pages/notifications/notifications.js
import { getNotifications, getUnreadCount, markAllAsRead } from '../../utils/request';
Page({
    data: {
        notifications: [],
        unreadCount: 0,
        isLoading: true,
        isMarkingAll: false
    },

    onLoad() {
        this.loadNotifications();
    },

    onShow() {
        this.loadUnreadCount();
    },

    onPullDownRefresh() {
        this.loadNotifications(true);
    },

    getNotificationTypeText(type) {
        const types = {
            'question_answered': '问题被回答',
            'answer_commented': '回答被评论',
            'answer_accepted': '回答被采纳',
            'mentioned': '被提及',
            'question_commented': '问题被评论',
            'comment_replied': '评论被回复'
        };
        return types[type];
    },
    getNotificationContent(notification) {
        const { notification_type, question, answer } = notification;

        switch (notification_type) {
            case 'question_answered':
                return `回答了你的问题: ${question.title}`;
            case 'answer_commented':
                return `评论了你的回答`;
            case 'answer_accepted':
                return `采纳了你的回答`;
            case 'question_commented':
                return `评论了你的问题: ${question.title}`;
            case 'comment_replied':
                return `回复了你的评论`;
            case 'mentioned':
                return `在${question ? '问题' : '回答'}中提到了你`;
            default:
                return '';
        }
    },
    loadNotifications(isRefresh = false) {
        this.setData({ isLoading: true });

        getNotifications()
            .then(res => {
                const notifications = (res.results || res).map(item => {
                    return {
                        ...item,
                        typeText: this.getNotificationTypeText(item.notification_type),
                        notificationText: this.getNotificationContent(item)
                    };
                });
                this.setData({
                    notifications: notifications,
                    isLoading: false
                });
                if (isRefresh) {
                    wx.stopPullDownRefresh();
                }
                this.loadUnreadCount();
            })
            .catch(err => {
                console.error('加载通知失败:', err);
                wx.showToast({
                    title: '加载通知失败',
                    icon: 'none'
                });
                this.setData({ isLoading: false });
                if (isRefresh) {
                    wx.stopPullDownRefresh();
                }
            });
    },

    loadUnreadCount() {
        getUnreadCount()
            .then(res => {
                this.setData({ unreadCount: res.count || 0 });
            })
            .catch(err => {
                console.error('获取未读数量失败:', err);
            });
    },

    markAllAsRead() {
        this.setData({ isMarkingAll: true });

        markAllAsRead()
            .then(res => {
                wx.showToast({
                    title: '全部标记为已读',
                    icon: 'success'
                });
                this.loadNotifications();
                this.setData({ unreadCount: 0 });
            })
            .catch(err => {
                console.error('标记全部已读失败:', err);
                wx.showToast({
                    title: '操作失败',
                    icon: 'none'
                });
            })
            .finally(() => {
                this.setData({ isMarkingAll: false });
            });
    },

    navigateToTarget(e) {
        const notification = e.currentTarget.dataset.notification;
        const { notification_type, question, answer, comment } = notification;

        // 根据通知类型决定跳转目标
        let url = '';
        if (question) {
            url = `/pages/question/question?id=${question.id}`;
        } else if (answer && answer.question) {
            url = `/pages/question/question?id=${answer.question}`;
        }

        if (url) {
            wx.navigateTo({
                url: url
            });
        }
    }
});
```

notifications.wxml

```html
<!-- pages/notifications/notifications.wxml -->
<view class="container">
  <!-- 顶部操作栏 -->
  <view class="action-bar">
    <text>未读通知: {{unreadCount}}</text>
    <button 
      size="mini" 
      bindtap="markAllAsRead"
      loading="{{isMarkingAll}}"
      disabled="{{unreadCount === 0 || isMarkingAll}}"
    >
      全部标记已读
    </button>
  </view>

  <!-- 通知列表 -->
  <view wx:if="{{!isLoading && notifications.length > 0}}" class="notification-list">
    <block wx:for="{{notifications}}" wx:key="id">
      <view 
        class="notification-item {{!item.is_read ? 'unread' : ''}}" 
        bindtap="navigateToTarget"
        data-notification="{{item}}"
      >
        <view class="notification-type">
            {{item.typeText}}
        </view>
        <view class="notification-content">
          <text class="actor">{{item.actor.username}}</text>
          <text>{{item.notificationText}}</text>
        </view>
        <view class="notification-time">
          {{item.created_at}}
        </view>
        <view wx:if="{{!item.is_read}}" class="unread-dot"></view>
      </view>
    </block>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading">加载中...</view>
  <view wx:if="{{!isLoading && notifications.length === 0}}" class="empty">暂无通知</view>
</view>
```

notifications.wxss

```css
/* pages/notifications/notifications.wxss */
.container {
    min-height: 100vh;
  }
  
  .action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #fff;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .action-bar button {
    margin: 0;
  }
  
  .notification-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .notification-item {
    position: relative;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .notification-item.unread {
    background: #f8f8ff;
  }
  
  .notification-type {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
  }
  
  .notification-content {
    font-size: 14px;
    line-height: 1.5;
    color: #666;
    margin-bottom: 5px;
  }
  
  .notification-content .actor {
    color: #1890ff;
    margin-right: 5px;
  }
  
  .notification-time {
    font-size: 12px;
    color: #999;
  }
  
  .unread-dot {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #f5222d;
  }
  
  .loading,
  .empty {
    text-align: center;
    padding: 20px;
    color: #999;
    font-size: 14px;
  }
```

### Search

search.js

```js
// pages/search/search.js
import { getQuestions, getTags } from '../../utils/request';

Page({
    data: {
        searchType: 'question', // 'question' 或 'tag'
        searchText: '',
        questions: [],
        tags: [],
        isLoading: false,
        activeTab: 'question', // 'question' 或 'tag'
        selectedTag: null
    },

    onLoad(options) {
        // 从首页点击标签跳转过来会带tag参数
        if (options.tag) {
            this.setData({
                activeTab: 'tag',
                selectedTag: options.tag,
                searchText: options.tag
            }, () => {
                this.searchByTag(options.tag);
            });
        }
    },

    onSearchInput(e) {
        this.setData({ searchText: e.detail.value });
    },

    switchTab(e) {
        const tab = e.currentTarget.dataset.tab;
        this.setData({
            activeTab: tab,
            questions: [],
            tags: []
        });
    },

    search() {
        const { searchText, activeTab } = this.data;
        if (!searchText.trim()) {
            wx.showToast({
                title: '请输入搜索内容',
                icon: 'none'
            });
            return;
        }

        if (activeTab === 'question') {
            this.searchQuestions(searchText);
        } else {
            this.searchTags(searchText);
        }
    },

    searchQuestions(keyword) {
        this.setData({ isLoading: true });
        getQuestions({ search: keyword, ordering: '-created_at' })
            .then(res => {
                this.setData({
                    questions: res.results || res,
                    isLoading: false
                });
            })
            .catch(err => {
                console.error('搜索问题失败:', err);
                wx.showToast({
                    title: '搜索失败',
                    icon: 'none'
                });
                this.setData({ isLoading: false });
            });
    },

    searchTags(keyword) {
        this.setData({ isLoading: true });
        getTags({ search: keyword })
            .then(res => {
                this.setData({
                    tags: res.results || res,
                    isLoading: false
                });
            })
            .catch(err => {
                console.error('搜索标签失败:', err);
                wx.showToast({
                    title: '搜索失败',
                    icon: 'none'
                });
                this.setData({ isLoading: false });
            });
    },

    searchByTag(tagName) {
        this.setData({ isLoading: true });
        getQuestions({ tag_name: tagName, ordering: '-created_at' })
            .then(res => {
                this.setData({
                    questions: res.results || res,
                    isLoading: false
                });
            })
            .catch(err => {
                console.error('按标签搜索问题失败:', err);
                wx.showToast({
                    title: '搜索失败',
                    icon: 'none'
                });
                this.setData({ isLoading: false });
            });
    },

    navigateToQuestion(e) {
        const id = e.currentTarget.dataset.id;
        wx.navigateTo({
            url: `/pages/question/question?id=${id}`
        });
    },

    navigateToTag(e) {
        const name = e.currentTarget.dataset.name;
        this.setData({
            selectedTag: name,
            searchText: name
        }, () => {
            this.searchByTag(name);
        });
    }
});
```

search.wxml

```html
<!-- pages/search/search.wxml -->
<view class="container">
    <!-- 搜索框 -->
    <view class="search-bar">
        <icon type="search" size="16" color="#999"></icon>
        <input placeholder="{{activeTab === 'question' ? '搜索问题' : '搜索标签'}}" value="{{searchText}}" bindinput="onSearchInput" confirm-type="search" bindconfirm="search" />
        <button class="search-btn" bindtap="search">搜索</button>
    </view>

    <!-- 选项卡 -->
    <view class="tabs">
        <view class="tab {{activeTab === 'question' ? 'active' : ''}}" bindtap="switchTab" data-tab="question">
            问题
        </view>
        <view class="tab {{activeTab === 'tag' ? 'active' : ''}}" bindtap="switchTab" data-tab="tag">
            标签
        </view>
    </view>

    <!-- 搜索结果 -->
    <view class="search-results">
        <!-- 问题搜索结果 -->
        <block wx:if="{{activeTab === 'question'}}">
            <block wx:if="{{questions.length > 0}}">
                <block wx:for="{{questions}}" wx:key="id">
                    <view class="question-item" bindtap="navigateToQuestion" data-id="{{item.id}}">
                        <view class="question-title">{{item.title}}</view>
                        <view class="question-meta">
                            <text>{{item.author.username}}</text>
                            <text>{{item.views}}浏览</text>
                            <text>{{item.answers_count}}回答</text>
                        </view>
                        <view class="question-tags">
                            <block wx:for="{{item.tags.slice(0, 3)}}" wx:key="id">
                                <text class="tag">{{item.name}}</text>
                            </block>
                        </view>
                    </view>
                </block>
            </block>
            <view wx:else class="empty">
                {{searchText ? '没有找到相关问题' : '请输入搜索内容'}}
            </view>
        </block>

        <!-- 标签搜索结果 -->
        <block wx:if="{{activeTab === 'tag'}}">
            <block wx:if="{{tags.length > 0}}">
                <view class="tags-container">
                    <block wx:for="{{tags}}" wx:key="id">
                        <view class="tag {{selectedTag == item.name ? 'active' : ''}}" bindtap="navigateToTag" data-name="{{item.name}}">
                            {{item.name}}
                            <text wx:if="{{item.usage_count}}" class="count">{{item.usage_count}}</text>
                        </view>
                    </block>
                </view>

                <!-- 选中标签后显示相关问题 -->
                <block wx:if="{{selectedTag && questions.length > 0}}">
                    <view class="section-title">相关问题</view>
                    <block wx:for="{{questions}}" wx:key="id">
                        <view class="question-item" bindtap="navigateToQuestion" data-id="{{item.id}}">
                            <view class="question-title">{{item.title}}</view>
                            <view class="question-meta">
                                <text>{{item.author.username}}</text>
                                <text>{{item.views}}浏览</text>
                                <text>{{item.answers_count}}回答</text>
                            </view>
                        </view>
                    </block>
                </block>
                <view wx:if="{{selectedTag && questions.length === 0}}" class="empty">
                    没有找到相关问题
                </view>
            </block>
            <view wx:else class="empty">
                {{searchText ? '没有找到相关标签' : '请输入标签名称'}}
            </view>
        </block>
    </view>

    <view wx:if="{{isLoading}}" class="loading">加载中...</view>
</view>
```

search.wxss

```css
/* pages/search/search.wxss */
.container {
    padding-bottom: 20px;
  }
  
  .search-bar {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 20px;
    padding: 8px 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .search-bar icon {
    margin-right: 8px;
  }
  
  .search-bar input {
    flex: 1;
    font-size: 14px;
  }
  
  .search-btn {
    margin-left: 10px;
    font-size: 14px;
    padding: 0 15px;
    height: 30px;
    line-height: 30px;
    border-radius: 15px;
    background: #1890ff;
    color: #fff;
    border: none;
  }
  
  .tabs {
    display: flex;
    border-bottom: 1px solid #eee;
    margin-bottom: 15px;
  }
  
  .tab {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    font-size: 14px;
    color: #666;
  }
  
  .tab.active {
    color: #1890ff;
    border-bottom: 2px solid #1890ff;
  }
  
  .search-results {
    min-height: 200px;
  }
  
  .question-item {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .question-title {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
  }
  
  .question-meta {
    display: flex;
    font-size: 12px;
    color: #999;
    margin-bottom: 8px;
  }
  
  .question-meta text {
    margin-right: 10px;
  }
  
  .question-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
  }
  
  .tag {
    padding: 4px 10px;
    background: #f0f0f0;
    border-radius: 15px;
    font-size: 12px;
    color: #666;
  }
  
  .tag.active {
    background: #e6f7ff;
    color: #1890ff;
    border: 1px solid #1890ff;
  }
  
  .tag .count {
    margin-left: 5px;
    color: #999;
  }
  
  .section-title {
    font-size: 16px;
    font-weight: bold;
    margin: 15px 0 10px;
    color: #333;
  }
  
  .loading,
  .empty {
    text-align: center;
    padding: 20px;
    color: #999;
    font-size: 14px;
  }
```

### User

查询用户的提问示例

```
import { getQuestions } from '../../utils/request';

// 查询用户ID为123的提问，这里可以从本地存储的用户信息中获取
getQuestions({ author: 123 }).then(res => {
    console.log('用户提问:', res);
});
```

查询用户的回答示例

```
import { getUserAnswers } from '../../utils/request';

// 查询用户ID为123的回答，这里可以从本地存储的用户信息中获取
getUserAnswers({ author: 123 }).then(res => {
    console.log('用户回答:', res);
});
```

查询用户的投票示例

```
import { getMyVote } from '../../utils/request';

// 查询当前用户的投票
getMyVote().then(res => {
    console.log('用户回答:', res);
});
```

